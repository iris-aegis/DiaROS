# First Stage ä¸­æ–­æˆ¦ç•¥ å®Ÿè£…ãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè£…æ—¥**: 2025-12-11
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†

---

## æ¦‚è¦

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§æ¤œè¨¼ã—ãŸã€ŒFirst stage ä¸­æ–­ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€ã‚’ã€å®Ÿéš›ã® NaturalLanguageGeneration.py ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«çµ±åˆã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€Second stage ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸéš›ã« First stage ã®ç”Ÿæˆã‚’ä¸­æ–­ã—ã¦ã€Second stage ã‚’å„ªå…ˆå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**æœŸå¾…åŠ¹æœ**:
- Second stage ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“çŸ­ç¸®ï¼š**156.7ms â†’ è¨±å®¹ç¯„å›²å†…**
- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŠ¹æœã«ã‚ˆã‚‹å…¨ä½“çš„ãªæ”¹å–„ï¼š**4.7%**

---

## å®Ÿè£…å†…å®¹

### 1. åˆ¶å¾¡å¤‰æ•°ã®è¿½åŠ ï¼ˆ`__init__` ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰

```python
# First stage ä¸­æ–­åˆ¶å¾¡ç”¨ã®å¤‰æ•°
self.first_stage_thread = None       # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰
self.cancel_first_stage = False      # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ©ã‚°
```

**å ´æ‰€**: [naturalLanguageGeneration.py:80-82](DiaROS_py/diaros/naturalLanguageGeneration.py#L80-L82)

---

### 2. Stageåˆ¥ã®å‡¦ç†ã‚’å®Ÿè£…ï¼ˆ`update()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰

#### First stage: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ

```python
if self.current_stage == 'first':
    # First stage: dialog_first_stage.txt ã§ç›¸æ§Œç”Ÿæˆï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
    self.cancel_first_stage = False
    self.first_stage_thread = threading.Thread(
        target=self.generate_first_stage,
        args=(query,),
        daemon=True
    )
    self.first_stage_thread.start()
```

**åŠ¹æœ**:
- First stage ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œï¼ˆéåŒæœŸå‡¦ç†ï¼‰
- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã™ãã«æ¬¡ã®å‡¦ç†ã«ç§»å‹•å¯èƒ½

#### Second stage: ä¸­æ–­å‡¦ç†ã‚’å®Ÿè¡Œ

```python
elif self.current_stage == 'second':
    # Second stage: First stage ã‚’ä¸­æ–­ã—ã¦å„ªå…ˆå®Ÿè¡Œ
    self.cancel_first_stage = True

    # ã‚¹ãƒ¬ãƒƒãƒ‰çµ‚äº†ã‚’çŸ­ãå¾…ã¤ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ 0.1sï¼‰
    if self.first_stage_thread:
        self.first_stage_thread.join(timeout=0.1)

    # Second stage å®Ÿè¡Œ
    self.generate_second_stage(query)
```

**åŠ¹æœ**:
- First stage ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
- çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ0.1ç§’ï¼‰ã§ã‚¹ãƒ¬ãƒƒãƒ‰çµ‚äº†ã‚’å¾…ã¤
- ãã®å¾Œ Second stage ã‚’å³åº§ã«å®Ÿè¡Œ

**å ´æ‰€**: [naturalLanguageGeneration.py:286-310](DiaROS_py/diaros/naturalLanguageGeneration.py#L286-L310)

---

### 3. ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç›£è¦–ã‚’è¿½åŠ ï¼ˆ`generate_first_stage()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰

Ollama API ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ«ãƒ¼ãƒ—å†…ã«ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ï¼š

```python
for line in response.iter_lines():
    # ã€é‡è¦ã€‘ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆSecond stage ãŒå„ªå…ˆã•ã‚Œã‚‹ï¼‰
    if self.cancel_first_stage:
        sys.stdout.write(f"[...][NLG FIRST_STAGE] â¸ï¸  ä¸­æ–­ä¿¡å·ã‚’å—ä¿¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™ï¼‰\n")
        sys.stdout.flush()
        response.close()
        self.first_stage_response = self.first_stage_response or "ã†ã‚“"
        return

    # ... é€šå¸¸ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç† ...
```

**åŠ¹æœ**:
- ãƒˆãƒ¼ã‚¯ãƒ³å—ä¿¡ãƒ«ãƒ¼ãƒ—ã®å„åå¾©ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ©ã‚°ã‚’ç¢ºèª
- ä¸­æ–­æ™‚ã¯å³åº§ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ"ã†ã‚“"ï¼‰ã‚’è¿”ã™
- ãƒªã‚½ãƒ¼ã‚¹æµªè²»ãªã—ï¼ˆresponse.close() ã§æ¥ç¶šã‚’é–‰ã˜ã‚‹ï¼‰

**å ´æ‰€**: [naturalLanguageGeneration.py:391-398](DiaROS_py/diaros/naturalLanguageGeneration.py#L391-L398)

---

## å‹•ä½œãƒ•ãƒ­ãƒ¼

### ã‚·ãƒŠãƒªã‚ª: First stage ä¸­ã€Second stage ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€

```
æ™‚åˆ»     ã‚¤ãƒ™ãƒ³ãƒˆ                çŠ¶æ…‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms     First stage é–‹å§‹         âœ… ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹
         â†“
50ms    First stage ãƒˆãƒ¼ã‚¯ãƒ³      ğŸ”„ ç”Ÿæˆä¸­
         ç”Ÿæˆä¸­
         â†“
100ms   ã€Second stage åˆ°ç€ã€‘    âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ©ã‚° = true
         cancel_first_stage
         = True è¨­å®š
         â†“
150ms   ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¤œçŸ¥           â¸ï¸ First stage ä¸­æ–­
                                  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¿”ã™
         â†“
155ms   Second stage é–‹å§‹        âœ… æœ¬å¿œç­”ç”Ÿæˆé–‹å§‹
         â†“
310ms   Second stage å®Œäº†        âœ… å¿œç­”è¿”å´
```

---

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

### å®Ÿè£…ãƒ†ã‚¹ãƒˆ

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯:

```bash
python3 -m py_compile DiaROS_py/diaros/naturalLanguageGeneration.py
# âœ… ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯: OK
```

### å®Ÿé‹ç”¨ãƒ†ã‚¹ãƒˆ

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å‹•ä½œç¢ºèªå¯èƒ½:

```bash
# å‰å›å®Ÿæ–½ã—ãŸãƒ†ã‚¹ãƒˆ
python3 test_direct_ollama_latency.py

# ã¾ãŸã¯

python3 test_gemma3_interrupt.py
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**:

```
[...][NLG] â³ First stage ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹ï¼ˆç›¸æ§Œç”Ÿæˆã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼‰
[...][NLG] â¸ï¸  First stage ã‚’ä¸­æ–­ï¼ˆSecond stage ã‚’å„ªå…ˆå®Ÿè¡Œï¼‰
[...][NLG FIRST_STAGE] â¸ï¸  ä¸­æ–­ä¿¡å·ã‚’å—ä¿¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™ï¼‰
[...][NLG SECOND_STAGE] ğŸ¤– æœ¬å¿œç­”ç”Ÿæˆé–‹å§‹ï¼ˆç›¸æ§Œ: 'ã†ã‚“'ï¼‰
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ¹æœ

### è¨ˆæ¸¬å€¤ï¼ˆå‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

| é …ç›® | å€¤ |
|---|---|
| API ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰å‰Šæ¸› | ~67.8ms |
| å…¨ä½“æ”¹å–„ç‡ | **4.7%** |
| ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ™ãƒ«ãƒšãƒŠãƒ«ãƒ†ã‚£ | **< 0.01ms** |

### å‰Šæ¸›ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

```
å¾“æ¥ï¼ˆé †åºå®Ÿè¡Œï¼‰:
First stage (187ms) â†’ Second stage (233ms)
= 420ms åˆè¨ˆ

æ”¹å–„ï¼ˆä¸¦åˆ—ãƒ»ä¸­æ–­æˆ¦ç•¥ï¼‰:
First stage (70ms) + ä¸­æ–­ â†’ Second stage (189msï¼‰
= 259ms å®Ÿè³ªã‚¿ã‚¤ãƒ 
â‰ˆ 4.7% æ”¹å–„
```

---

## é‡è¦ãªè¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

### 1. ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨æ€§

- ãƒ•ãƒ©ã‚°ã¯ãƒ¡ãƒ¢ãƒªã§ atomic ãªæ“ä½œã®ãŸã‚ã€Lock ä¸è¦
- Python ã® GIL ã«ã‚ˆã‚Šç›¸äº’æ’é™¤ãŒä¿è¨¼ã•ã‚Œã‚‹

```python
self.cancel_first_stage = True  # å®‰å…¨ãªæ“ä½œ
```

### 2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ç¢ºå®Ÿãªè¨­å®š

- First stage ãŒå®Œå…¨ã«å®Ÿè¡Œã§ããªã‹ã£ãŸå ´åˆã€"ã†ã‚“" ã‚’è¿”ã™
- None ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„

```python
self.first_stage_response = self.first_stage_response or "ã†ã‚“"
```

### 3. ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯é˜²æ­¢

- daemon=True ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆï¼ˆè¦ªã‚¹ãƒ¬ãƒƒãƒ‰çµ‚äº†æ™‚ã«è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
- response.close() ã§ HTTP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ˜ç¤ºçš„ã«ã‚¯ãƒ­ãƒ¼ã‚º

```python
self.first_stage_thread = threading.Thread(
    target=self.generate_first_stage,
    args=(query,),
    daemon=True  # â† è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
)
```

---

## æ³¨æ„äº‹é …

### 1. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ï¼ˆ0.1ç§’ï¼‰

```python
self.first_stage_thread.join(timeout=0.1)
```

- ã“ã‚Œã‚ˆã‚Šé•·ã„ã¨ Second stage ãŒé…å»¶
- ã“ã‚Œã‚ˆã‚ŠçŸ­ã„ã¨ First stage ã‚¹ãƒ¬ãƒƒãƒ‰ãŒæ®‹å­˜

**æ¨å¥¨å€¤**: 100-200ms

### 2. Second stage å“è³ªç¢ºä¿

- First stage çµæœãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚Œã°å„ªå…ˆä½¿ç”¨
- ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ"ã†ã‚“"ï¼‰ã‚’ä½¿ç”¨

```python
prompt_with_backchannel = prompt_with_asr.replace(
    '{ã“ã“ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ¿å…¥}',
    self.first_stage_response  # â† ä¸­æ–­å¾Œã§ã‚‚åˆ©ç”¨å¯èƒ½
)
```

### 3. ãƒ­ã‚°å‡ºåŠ›

ä¸­æ–­ãŒç™ºç”Ÿã—ãŸã“ã¨ã‚’è¨˜éŒ²ï¼š

```
[HH:MM:SS.mmm][NLG] â¸ï¸  First stage ã‚’ä¸­æ–­ï¼ˆSecond stage ã‚’å„ªå…ˆå®Ÿè¡Œï¼‰
[HH:MM:SS.mmm][NLG FIRST_STAGE] â¸ï¸  ä¸­æ–­ä¿¡å·ã‚’å—ä¿¡
```

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… å®Œäº†é …ç›®

- [x] åˆ¶å¾¡å¤‰æ•°ã‚’ `__init__` ã«è¿½åŠ 
- [x] `update()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ stage åˆ¥åˆ†å²ã‚’å®Ÿè£…
- [x] First stage ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰åŒ–
- [x] Second stage ã§ä¸­æ–­å‡¦ç†ã‚’è¿½åŠ 
- [x] `generate_first_stage()` ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç›£è¦–ã‚’è¿½åŠ 
- [x] ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿæ–½

### ğŸ“‹ å‹•ä½œç¢ºèªå¾…ã¡

- [ ] å®Ÿé‹ç”¨ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] ä¸­æ–­æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨æ€§ã‚’ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã‚’å®Ÿæ¸¬

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### çŸ­æœŸï¼ˆç›´è¿‘ï¼‰

1. **å®Ÿé‹ç”¨ãƒ†ã‚¹ãƒˆ**: ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å¾Œã®å‹•ä½œç¢ºèª
2. **ãƒ­ã‚¸ãƒƒãƒˆãƒã‚§ãƒƒã‚¯**: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§ä¸­æ–­ãŒæ­£å¸¸ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
3. **æ€§èƒ½è¨ˆæ¸¬**: å®Ÿéš›ã® Second stage ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’æ¸¬å®š

### ä¸­æœŸï¼ˆ1-2é€±é–“ï¼‰

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§åŠ¹æœæ¸¬å®š
2. **ãƒ­ã‚°åˆ†æ**: ä¸­æ–­ç™ºç”Ÿé »åº¦ã¨å‰Šæ¸›æ™‚é–“ã®å®Ÿç¸¾é›†è¨ˆ

### é•·æœŸï¼ˆ1-3ã‹æœˆï¼‰

1. **ã•ã‚‰ãªã‚‹æœ€é©åŒ–**: llama.cpp ã¸ã®ç§»è¡Œæ¤œè¨
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å…¨ä½“çš„ãªã‚·ã‚¹ãƒ†ãƒ é«˜é€ŸåŒ–ã®æ¤œè¨

---

## å‚è€ƒè³‡æ–™

- [IMPLEMENTATION_RECOMMENDATION.md](IMPLEMENTATION_RECOMMENDATION.md) - å®Ÿè£…æ¨å¥¨ãƒ¬ãƒãƒ¼ãƒˆ
- [NATIVE_INFERENCE_OVERHEAD_DISCOVERY.md](NATIVE_INFERENCE_OVERHEAD_DISCOVERY.md) - ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰åˆ†æ
- [OLLAMA_API_OVERHEAD_ANALYSIS.md](OLLAMA_API_OVERHEAD_ANALYSIS.md) - API ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰è©³ç´°
- [test_direct_ollama_latency.py](test_direct_ollama_latency.py) - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆå‚è€ƒå®Ÿè£…ï¼‰

---

**ç½²å**: Claude Code
**æ—¥ä»˜**: 2025-12-11
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†ãƒ»ãƒ†ã‚¹ãƒˆå¾…ã¡

