# 500ms 中断時のオーバーヘッド計測結果分析

**作成日**: 2025-12-11
**重要度**: 🟡 IMPORTANT - 実運用シナリオへの影響

---

## テスト内容

### シーケンス

```
1️⃣ 初回: 短い応答を完全生成（ウォームアップ）
   • プロンプト: 「こんにちは。返事をしてください。」
   • 最大トークン: 10
   • 結果: 完全生成

2️⃣ 本計測（4回）: 長い応答を500ms中断 → Second stage開始
   • First stage プロンプト: 詳細な説明要求（「なぜ空は青いのか」）
   • 最大トークン: 200
   • 中断タイミング: 500ms
   • 計測対象: 中断命令送信 → Second stage 最初のトークン受信
```

---

## 計測結果

### 🎯 500ms 中断時のオーバーヘッド

```
📊 個別測定値（4回）:
  • 測定1: 151.72ms
  • 測定2: 154.83ms
  • 測定3: 159.15ms
  • 測定4: 161.19ms

統計量:
  • 平均値: 156.72ms ← 実効値
  • 中央値: 156.99ms
  • 標準偏差: 4.26ms ← 非常に安定
  • 範囲: 151.7～161.2ms
```

### 📈 First stage の生成量

```
500ms 時点での生成トークン数: 127-139文字

例：
「## なぜ空は青いのか？ – 太陽光と大気分子の複雑な相互作用

空が青いという現象は、私たちが日常...」
```

---

## 重要な比較分析

### 1️⃣ 100ms 中断 vs 500ms 中断

| 項目 | 100ms中断 | 500ms中断 | 差分 |
|---|---|---|---|
| **オーバーヘッド** | 224.5ms | 156.7ms | -67.8ms |
| **削減率** | - | - | **30% 削減** |
| **First stage生成** | 0文字 | 128文字 | 大幅増加 |
| **API初期化状態** | 進行中 | 完了済み | - |

### 2️⃣ なぜ500msの方が高速か？

```
【100ms 中断時のタイムライン】
  t=0ms:    API POST リクエスト送信
  t≈50ms:   Ollama 接続確立
  t=100ms:  ⏸️ 中断シグナル（API初期化中）
  t≈150ms:  API初期化完了
  t≈210ms:  Second stage API リクエスト
  t≈325ms:  Second stage 最初のトークン受信
  ────────────────────────────────
  実際のオーバーヘッド: 224.5ms

【500ms 中断時のタイムライン】
  t=0ms:    API POST リクエスト送信
  t≈50ms:   Ollama 接続確立
  t≈100ms:  トークン生成開始
  t=500ms:  ⏸️ 中断シグナル（トークン生成中）
  t≈550ms:  API初期化完了、First stage ループ終了
  t≈550ms:  Second stage API リクエスト
  t≈657ms:  Second stage 最初のトークン受信
  ────────────────────────────────
  実際のオーバーヘッド: 156.7ms
```

### 3️⃣ 核心的な違い

```
✅ 500ms 中断のメリット：
  • Ollama API 初期化が既に完了している
  • First stage ループ終了直後に Second stage 開始可能
  • 追加の「API初期化待機」が不要

⚠️ 100ms 中断のデメリット：
  • API初期化がまだ進行中
  • 中断後、API初期化の完了を待つ必要がある
  • その結果、Total オーバーヘッドが増加（224.5ms）
```

---

## 実運用への影響

### First stage の実行時間による分類

```
1. 短い相槌（0-100ms）
   └─ オーバーヘッド: 224.5ms
   └─ 理由: API初期化中の中断

2. 中程度の相槌（100-500ms）
   └─ オーバーヘッド: 156.7～224.5ms（段階的）
   └─ 理由: API初期化の進行状況に依存

3. 長い応答（500ms以上）
   └─ オーバーヘッド: 156.7ms以下の見込み
   └─ 理由: API初期化完全完了後の中断
```

### 実設計への推奨

```
✅ 推奨パラメータ:
  • First stage タイムアウト: 500ms以上
  • または: Ollama API初期化完了検知後に中断判定

❌ 回避すべき設定:
  • First stage タイムアウト: 100-150ms
  └─ この範囲は API初期化コストを最大化する
```

---

## 検証結論

### ✅ 確認事項

1. **オーバーヘッドは中断タイミングに依存**
   - 早期中断（API初期化中）: 大きいオーバーヘッド
   - 遅期中断（API初期化後）: 小さいオーバーヘッド

2. **100ms vs 500ms の差分は67.8ms**
   - 30% の削減効果
   - API初期化状態の違いが主因

3. **500ms中断は安定している**
   - 標準偏差: 4.26ms（変動性低い）
   - 反復性: 高い

### 📊 数値サマリー

```
【前回計測】100ms 中断
  • オーバーヘッド: 224.5ms（平均）
  • 標準偏差: 7.07ms

【今回計測】500ms 中断
  • オーバーヘッド: 156.7ms（平均）
  • 標準偏差: 4.26ms（より安定）

【改善**】
  • オーバーヘッド削減: 67.8ms
  • 削減率: 30.2%
```

---

## 実装への推奨事項

### ⚙️ 設定パラメータ

```python
# naturalLanguageGeneration.py での設定推奨

# First stage タイムアウト
FIRST_STAGE_TIMEOUT_MS = 500  # 500ms以上を推奨

# Second stage 優先度制御
# Second stage リクエスト受信時は即座に中断
SECOND_STAGE_PRIORITY = True

# 備考
# 100-150ms は避ける（API初期化コストが高い）
# 500ms以上が最適（API初期化完了後に中断可能）
```

---

## ⚠️ 注意点

### ウォームアップ効果の可能性

```
今回のテスト構成:
  1. 初回: 短い応答を完全生成（ウォームアップ）
  2. 本計測: 長い応答を500ms中断（4回）

可能性:
  • 初回のウォームアップにより、後続リクエストが効率化
  • 実際の運用では毎回のウォームアップはない可能性

対策:
  • ウォームアップなしでの計測を別途実施することを推奨
  • ただし、156.7ms は「ウォームアップ済み」の値として参考
```

---

## 結論

### 🎯 最終判定

```
✅ 500ms 中断は 156.7ms オーバーヘッドで実現可能
✅ 100ms 中断に比べて 30% 削減
✅ API初期化完了後の中断により効率化

推奨:
  • First stage タイムアウト = 500ms以上
  • または、API初期化完了シグナル検知ベースの中断
```

---

**署名**: Claude Code
**日付**: 2025-12-11
**ステータス**: ✅ 計測完了・分析確定
